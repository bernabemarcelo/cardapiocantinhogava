<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cardápio Digital</title>
  <meta name="description" content="Cardápio digital com pedidos via WhatsApp" />
  <style>
    :root{
      --bg:#0f1115;
      --card:#161a22;
      --muted:#a7b0c0;
      --text:#e8ecf3;
      --accent:#5cc97b;
      --danger:#ff6b6b;
      --primary:#6ca8ff;
      --shadow: 0 8px 24px rgba(0,0,0,0.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:linear-gradient(180deg,#0e1014,#0b0d11);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;background:rgba(15,17,21,0.7);backdrop-filter:blur(8px);z-index:20;border-bottom:1px solid #1f2430}
    .brand{display:flex;gap:12px;align-items:center;padding:14px 0}
    .brand-logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#4d7cff,#94e2ff);box-shadow:var(--shadow)}
    .brand h1{font-size:20px;margin:0}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 16px}
    .search{flex:1;min-width:220px}
    .input{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid #273044;background:#0f131b;color:var(--text)
    }
    .pill{padding:8px 12px;border-radius:999px;border:1px solid #273044;background:#0f131b;color:var(--muted);cursor:pointer}
    .pill.active{border-color:var(--primary);color:#cfe0ff}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-8{grid-column:span 12}
    .col-4{grid-column:span 12}
    @media(min-width:960px){.col-8{grid-column:span 8}.col-4{grid-column:span 4}}
    .card{background:var(--card);border:1px solid #1f2430;border-radius:var(--radius);box-shadow:var(--shadow)}
    .card.section{padding:16px}
    .cat-title{margin:4px 0 10px;font-size:18px;color:#d7def0}
    .subcat{margin:6px 0 10px;font-size:15px;color:#aeb7cc}
    .item{display:flex;gap:12px;padding:12px;border:1px solid #232a38;border-radius:12px;background:#121722}
    .item + .item{margin-top:10px}
    .item img{width:84px;height:84px;border-radius:10px;object-fit:cover;background:#0c0f14;border:1px solid #273044}
    .item-body{flex:1;min-width:0}
    .item-name{margin:0 0 4px;font-weight:600}
    .item-desc{margin:0 0 6px;color:var(--muted);font-size:14px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .price{font-weight:700;color:#dfe8ff}
    .qty{display:flex;align-items:center;border:1px solid #273044;border-radius:10px}
    .qty button{background:transparent;border:0;color:#cfe0ff;font-size:18px;width:34px;height:34px;cursor:pointer}
    .qty input{width:44px;text-align:center;background:#0f131b;border:0;color:var(--text);height:34px;border-left:1px solid #273044;border-right:1px solid #273044;border-radius:0}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #2a3350;background:#12203a;color:#dfe8ff;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,#4d7cff,#6bc5ff);border-color:#3a68d8;color:#091120;font-weight:700}
    .btn.success{background:linear-gradient(135deg,#49d692,#31b96f);border-color:#2d915f;color:#06160f;font-weight:700}
    .btn.danger{background:linear-gradient(135deg,#ff8b8b,#ff6b6b);border-color:#c74343;color:#2b0606;font-weight:700}
    .muted{color:var(--muted)}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin:0 0 10px}
    .small{font-size:12px}
    .chip{padding:6px 10px;border-radius:999px;background:#101523;border:1px solid #28314b;color:#9fb2df}
    footer{margin:26px 0 80px;color:#8f9bb5}
    .footer-actions{position:fixed;left:0;bottom:0;right:0;background:rgba(15,17,21,0.88);backdrop-filter:blur(8px);border-top:1px solid #1f2430;padding:10px;z-index:30}
    .footer-bar{display:flex;gap:10px;align-items:center;max-width:1100px;margin:0 auto}
    .admin-button{margin-left:auto}
    .admin-btn{padding:8px 10px;border-radius:999px;border:1px solid #2a3350;background:#0f131b;color:#cbd6f6;font-size:12px;cursor:pointer}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(720px,calc(100% - 24px));max-height:85vh;overflow:auto;background:var(--card);border:1px solid #2a3346;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .modal h3{margin:0 0 10px}
    .form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .form-row .input,.form-row textarea{flex:1}
    textarea{min-height:80px;resize:vertical}
    .divider{height:1px;background:#223;opacity:0.6;margin:12px 0}
    .contact{display:flex;gap:8px;flex-wrap:wrap}
    .contact a{color:#b8ccff;text-decoration:none}
    .hide{display:none!important}
    .hint{font-size:12px;color:#8fa0c6}
  </style>
</head>
<body>
  <!-- Opcional: cole aqui sua config do Firebase para sincronização em tempo real -->
  <script>
    // Substitua pelo seu objeto de configuração do Firebase (opcional).
    // Se vazio, o app usa localStorage automaticamente.
    window.FIREBASE_CONFIG = {
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
      // storageBucket: "...",
      // messagingSenderId: "...",
      // appId: "..."
    };
  </script>

  <header>
    <div class="container">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div>
          <h1 id="storeName">Minha Loja</h1>
          <div id="storeTag" class="muted small">Aberto hoje • Entrega e retirada</div>
        </div>
      </div>
      <div class="toolbar">
        <div class="search">
          <input id="searchInput" class="input" placeholder="Buscar itens..." />
        </div>
        <button class="pill active" data-filter="all">Tudo</button>
        <div id="categoryFilters" class="toolbar"></div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="col-8">
        <div id="menuRoot" class="card section">
          <div class="section-title">
            <h2 style="margin:0">Cardápio</h2>
            <span class="chip" id="itemsCount">0 itens</span>
          </div>
          <div class="divider"></div>
          <div id="menuContent"></div>
        </div>
      </section>

      <aside class="col-4">
        <div class="card section">
          <div class="section-title">
            <h2 style="margin:0">Seu Pedido</h2>
            <button id="clearCartBtn" class="btn danger small">Limpar</button>
          </div>
          <div id="cartList"></div>
          <div class="divider"></div>
          <div class="form-row">
            <input id="customerName" class="input" placeholder="Seu nome" />
          </div>
          <div class="form-row">
            <input id="customerPhone" class="input" placeholder="Telefone (WhatsApp)" />
          </div>
          <div class="form-row">
            <input id="customerAddress" class="input" placeholder="Endereço (Rua, nº, bairro)" />
          </div>
          <div class="form-row">
            <select id="paymentMethod" class="input">
              <option value="PIX">PIX</option>
              <option value="Dinheiro">Dinheiro</option>
              <option value="Cartão">Cartão</option>
            </select>
            <input id="changeValue" class="input" placeholder="Troco para quanto? (se dinheiro)" />
          </div>
          <div class="form-row">
            <textarea id="orderNote" class="input" placeholder="Observação do pedido (opcional)"></textarea>
          </div>
          <div class="divider"></div>
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="muted small">Subtotal</div>
              <div id="subtotalValue" class="price">R$ 0,00</div>
            </div>
            <div>
              <div class="muted small">Entrega</div>
              <div id="deliveryValue" class="price">R$ 0,00</div>
            </div>
            <div>
              <div class="muted small">Total</div>
              <div id="totalValue" class="price">R$ 0,00</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="row">
            <button id="sendWhatsApp" class="btn success" style="flex:1">Enviar WhatsApp (Mini Cupom)</button>
          </div>
        </div>

        <div class="card section" style="margin-top:16px">
          <div class="section-title">
            <h2 style="margin:0">Contato</h2>
            <button id="toggleContactBtn" class="btn small">Mostrar/Ocultar</button>
          </div>
          <div id="contactBlock" class="contact">
            <a id="phoneLink" href="#" target="_blank" rel="noopener">Telefone</a>
            <a id="whatsLink" href="#" target="_blank" rel="noopener">WhatsApp</a>
            <a id="instaLink" href="#" target="_blank" rel="noopener">Instagram</a>
            <a id="fbLink" href="#" target="_blank" rel="noopener">Facebook</a>
          </div>
          <div class="hint">Você pode remover campos de contato no painel Admin.</div>
        </div>
      </aside>
    </div>

    <footer>
      <p id="footerNote" class="muted small">Obrigado por escolher nossa loja.</p>
    </footer>
  </main>

  <div class="footer-actions">
    <div class="footer-bar">
      <span class="muted small">Precisa editar o cardápio?</span>
      <div class="admin-button">
        <button id="openAdmin" class="admin-btn">Admin</button>
      </div>
    </div>
  </div>

  <!-- Modal Admin -->
  <div id="adminModal" class="modal-backdrop">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h3>Painel Admin</h3>
        <button id="closeAdmin" class="btn small">Fechar</button>
      </div>
      <div class="divider"></div>

      <div class="form-row">
        <input id="adminPasswordInput" class="input" placeholder="Senha do admin" type="password" />
        <button id="adminLoginBtn" class="btn">Entrar</button>
        <span id="adminLoginStatus" class="hint"></span>
      </div>

      <div id="adminContent" class="hide">
        <h4 style="margin:8px 0">Informações da Loja</h4>
        <div class="form-row">
          <input id="cfgStoreName" class="input" placeholder="Nome da Loja" />
          <input id="cfgStoreTag" class="input" placeholder="Slogan/Status (ex: Aberto hoje)" />
        </div>
        <div class="form-row">
          <input id="cfgDeliveryFee" class="input" placeholder="Taxa de entrega (ex: 7.00)" />
          <input id="cfgWhatsTarget" class="input" placeholder="Número WhatsApp destino (só dígitos, ex: 5511999999999)" />
        </div>
        <div class="form-row">
          <input id="cfgFooterNote" class="input" placeholder="Mensagem de rodapé" />
        </div>

        <h4 style="margin:8px 0">Contato</h4>
        <div class="form-row">
          <input id="cfgPhone" class="input" placeholder="Telefone (link tel:)" />
          <input id="cfgWhats" class="input" placeholder="WhatsApp (link wa.me)" />
        </div>
        <div class="form-row">
          <input id="cfgInsta" class="input" placeholder="Instagram (https://...)" />
          <input id="cfgFb" class="input" placeholder="Facebook (https://...)" />
        </div>
        <div class="form-row">
          <label class="muted small"><input type="checkbox" id="hidePhone"> Ocultar Telefone</label>
          <label class="muted small"><input type="checkbox" id="hideWhats"> Ocultar WhatsApp</label>
          <label class="muted small"><input type="checkbox" id="hideInsta"> Ocultar Instagram</label>
          <label class="muted small"><input type="checkbox" id="hideFb"> Ocultar Facebook</label>
        </div>

        <div class="divider"></div>

        <h4 style="margin:8px 0">Categorias e Itens</h4>
        <div class="form-row">
          <input id="newCatName" class="input" placeholder="Nome da nova categoria" />
          <button id="addCategoryBtn" class="btn">Adicionar categoria</button>
        </div>
        <div id="categoriesEditor"></div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between">
          <button id="saveAllBtn" class="btn primary">Salvar alterações</button>
          <span class="hint">Salva no Firebase (se configurado) ou localStorage.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (opcional) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
    // Estado base
    const DEFAULT_STATE = {
      settings:{
        adminPassword:"admin123",
        storeName:"Minha Loja",
        storeTag:"Aberto hoje • Entrega e retirada",
        deliveryFee:0,
        whatsTarget:"", // ex: 5511999999999
        footerNote:"Obrigado por escolher nossa loja.",
        contact:{
          phone:"",
          whats:"",
          insta:"",
          fb:"",
          hide:{phone:false,whats:false,insta:false,fb:false}
        }
      },
      menu:[
        {
          id: uid(), name:"Lanches", subgroups:[
            {
              id: uid(), name:"Artesanais", items:[
                {id:uid(), name:"X-Burguer", desc:"Pão, carne, queijo", price:18.00, image:"", options:"", available:true},
                {id:uid(), name:"X-Salada", desc:"Alface, tomate, queijo", price:20.00, image:"", options:"", available:true}
              ]
            }
          ]
        }
      ],
      cart:[]
    };

    let APP_STATE = null;
    let useFirebase = false;
    let db = null;
    const FIREBASE_DOC = "app/state"; // Documento único para estado

    // Util
    function uid(){return Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4)}
    const R$ = v => (v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    function parseMoney(str){
      if(!str) return 0;
      const n = String(str).replace(/[^\d,.-]/g,"").replace(".","").replace(",",".");
      const v = parseFloat(n);
      return isNaN(v)?0:v;
    }
    function debounce(fn,ms=300){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

    // Persistência
    function loadLocal(){
      try{
        const raw = localStorage.getItem("cardapio_state_v3");
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){return null}
    }
    function saveLocal(state){
      try{ localStorage.setItem("cardapio_state_v3", JSON.stringify(state)); }catch(e){}
    }

    async function initFirebaseIfConfig(){
      const cfg = window.FIREBASE_CONFIG||{};
      if(!cfg.apiKey) return false;
      try{
        const app = firebase.initializeApp(cfg);
        db = firebase.firestore(app);
        useFirebase = true;
        return true;
      }catch(e){
        console.warn("Falha ao iniciar Firebase, usando localStorage.", e);
        useFirebase = false;
        return false;
      }
    }

    async function loadState(){
      const hasFb = await initFirebaseIfConfig();
      if(hasFb){
        // Tenta ler do Firestore
        try{
          const docRef = db.collection("app").doc("state");
          const doc = await docRef.get();
          if(doc.exists){
            APP_STATE = doc.data();
            // Sanitiza estrutura mínima
            APP_STATE.settings ||= DEFAULT_STATE.settings;
            APP_STATE.menu ||= DEFAULT_STATE.menu;
            APP_STATE.cart ||= [];
            return;
          }
        }catch(e){ console.warn("Erro Firestore get:", e) }
      }
      // Fallback local
      APP_STATE = loadLocal() || structuredClone(DEFAULT_STATE);
    }

    async function saveState(){
      // Nunca persistimos o carrinho no Firestore (somente menu/settings). Carrinho é local.
      const dataToSave = {
        settings: APP_STATE.settings,
        menu: APP_STATE.menu,
        cart: [] // garantir vazio ao salvar remoto
      };
      if(useFirebase){
        try{
          await db.collection("app").doc("state").set(dataToSave,{merge:true});
          return;
        }catch(e){
          console.warn("Erro Firestore set:", e);
        }
      }
      // Local
      saveLocal({...APP_STATE, cart: APP_STATE.cart});
    }

    function listenRealtime(){
      if(!useFirebase) return;
      const docRef = db.collection("app").doc("state");
      docRef.onSnapshot(snap=>{
        if(!snap.exists) return;
        const data = snap.data() || {};
        // Só atualiza menu/settings; não mexe no carrinho local
        APP_STATE.settings = data.settings || APP_STATE.settings;
        APP_STATE.menu = data.menu || APP_STATE.menu;
        renderAll();
      });
    }

    // Render
    function renderAll(){
      // Topo/loja
      document.getElementById("storeName").textContent = APP_STATE.settings.storeName || "Minha Loja";
      document.getElementById("storeTag").textContent = APP_STATE.settings.storeTag || "";
      document.getElementById("footerNote").textContent = APP_STATE.settings.footerNote || "";

      // Contato
      const c = APP_STATE.settings.contact || {};
      setContactLink("phoneLink", c.phone, c.hide?.phone, v=>v);
      setContactLink("whatsLink", c.whats, c.hide?.whats, v=>v);
      setContactLink("instaLink", c.insta, c.hide?.insta, v=>v);
      setContactLink("fbLink", c.fb, c.hide?.fb, v=>v);

      // Filtros
      renderFilters();

      // Menu
      renderMenu();

      // Cart totals
      updateCartTotals();

      // Admin (se aberto)
      if(!document.getElementById("adminContent").classList.contains("hide")){
        renderAdmin();
      }
    }

    function setContactLink(id, val, hidden, fmt){
      const el = document.getElementById(id);
      if(hidden || !val){ el.classList.add("hide"); el.href="#"; }
      else { el.classList.remove("hide"); el.href=fmt(val); }
    }

    function renderFilters(){
      const wrap = document.getElementById("categoryFilters");
      wrap.innerHTML = "";
      (APP_STATE.menu||[]).forEach(cat=>{
        const b = document.createElement("button");
        b.className = "pill";
        b.textContent = cat.name;
        b.dataset.filter = `cat:${cat.id}`;
        b.addEventListener("click", onFilterClick);
        wrap.appendChild(b);
      });
    }

    let ACTIVE_FILTER = "all";
    function onFilterClick(e){
      const f = e.currentTarget.dataset.filter;
      ACTIVE_FILTER = f;
      // toggle classes
      document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
      e.currentTarget.classList.add("active");
      renderMenu();
    }

    const filteredItemsCount = ()=>{
      let count=0;
      (APP_STATE.menu||[]).forEach(cat=>{
        if(ACTIVE_FILTER!=="all" && ACTIVE_FILTER!==`cat:${cat.id}`) return;
        (cat.subgroups||[]).forEach(sg=>{
          (sg.items||[]).forEach(it=>{
            if(!matchSearch(it)) return;
            count++;
          });
        });
      });
      return count;
    };

    function renderMenu(){
      const root = document.getElementById("menuContent");
      root.innerHTML = "";
      let totalItems = 0;
      (APP_STATE.menu||[]).forEach(cat=>{
        if(ACTIVE_FILTER!=="all" && ACTIVE_FILTER!==`cat:${cat.id}`) return;
        const catWrap = document.createElement("div");
        const h = document.createElement("h3");
        h.className = "cat-title";
        h.textContent = cat.name;
        catWrap.appendChild(h);

        (cat.subgroups||[]).forEach(sg=>{
          const sgh = document.createElement("div");
          sgh.className = "subcat";
          sgh.textContent = sg.name;
          catWrap.appendChild(sgh);

          (sg.items||[]).forEach(it=>{
            if(!matchSearch(it)) return;
            totalItems++;
            catWrap.appendChild(renderItem(it, cat.id, sg.id));
          });
        });

        root.appendChild(catWrap);
      });
      document.getElementById("itemsCount").textContent = `${filteredItemsCount()} itens`;
    }

    function matchSearch(it){
      const q = (document.getElementById("searchInput").value||"").trim().toLowerCase();
      if(!q) return true;
      return [it.name,it.desc,it.options].filter(Boolean).some(v=>String(v).toLowerCase().includes(q));
    }

    function renderItem(it, catId, sgId){
      const wrap = document.createElement("div");
      wrap.className = "item";
      const img = document.createElement("img");
      img.src = it.image || "https://placehold.co/168x168/0b0f16/96a3b8?text=IMG";
      img.alt = it.name;

      const body = document.createElement("div");
      body.className = "item-body";
      const title = document.createElement("h4");
      title.className = "item-name";
      title.textContent = it.name + (it.available?"":" (Indisponível)");
      const desc = document.createElement("div");
      desc.className = "item-desc";
      desc.textContent = it.desc || "";

      const row = document.createElement("div");
      row.className = "row";
      const price = document.createElement("div");
      price.className = "price";
      price.textContent = R$(it.price);

      const qty = document.createElement("div");
      qty.className = "qty";
      const minus = document.createElement("button"); minus.textContent = "−";
      const input = document.createElement("input"); input.value = 1; input.inputMode="numeric";
      const plus = document.createElement("button"); plus.textContent = "+";
      minus.addEventListener("click", ()=> input.value = Math.max(1, (parseInt(input.value)||1)-1));
      plus.addEventListener("click", ()=> input.value = (parseInt(input.value)||1)+1);

      qty.append(minus,input,plus);

      const addBtn = document.createElement("button");
      addBtn.className = "btn primary";
      addBtn.textContent = "Adicionar";
      addBtn.disabled = !it.available;
      addBtn.addEventListener("click", ()=>{
        const q = Math.max(1, parseInt(input.value)||1);
        addToCart({item: it, qty:q});
      });

      row.append(price, qty, addBtn);

      body.append(title,desc,row);

      wrap.append(img, body);
      return wrap;
    }

    // Carrinho
    function addToCart({item, qty}){
      const existing = APP_STATE.cart.find(c=>c.id===item.id);
      if(existing){ existing.qty += qty; }
      else {
        APP_STATE.cart.push({
          id:item.id, name:item.name, price:item.price, qty,
          options:item.options||"", note:""
        });
      }
      renderCart();
      updateCartTotals();
      saveLocal(APP_STATE);
    }

    function renderCart(){
      const list = document.getElementById("cartList");
      list.innerHTML = "";
      if((APP_STATE.cart||[]).length===0){
        list.innerHTML = `<div class="muted small">Seu carrinho está vazio.</div>`;
        return;
      }
      APP_STATE.cart.forEach((c,idx)=>{
        const row = document.createElement("div");
        row.className = "item";
        const body = document.createElement("div");
        body.className = "item-body";
        const title = document.createElement("div");
        title.className = "item-name";
        title.textContent = `${c.qty}x ${c.name}`;
        const opt = document.createElement("div");
        opt.className = "item-desc";
        opt.textContent = c.options ? `Variação: ${c.options}` : "Sem variação";

        const note = document.createElement("textarea");
        note.className = "input";
        note.placeholder = "Observação (opcional)";
        note.value = c.note||"";
        note.addEventListener("input", e=>{
          APP_STATE.cart[idx].note = e.target.value||"";
          saveLocal(APP_STATE);
        });

        const row2 = document.createElement("div");
        row2.className = "row";
        const price = document.createElement("div");
        price.className = "price";
        price.textContent = `${R$(c.price)} — Sub: ${R$(c.price*c.qty)}`;

        const qty = document.createElement("div");
        qty.className = "qty";
        const minus = document.createElement("button"); minus.textContent = "−";
        const input = document.createElement("input"); input.value = c.qty; input.inputMode="numeric";
        const plus = document.createElement("button"); plus.textContent = "+";
        minus.addEventListener("click", ()=>{
          const v = Math.max(1, (parseInt(input.value)||1)-1);
          input.value = v; APP_STATE.cart[idx].qty = v; renderCart(); updateCartTotals(); saveLocal(APP_STATE);
        });
        plus.addEventListener("click", ()=>{
          const v = (parseInt(input.value)||1)+1;
          input.value = v; APP_STATE.cart[idx].qty = v; renderCart(); updateCartTotals(); saveLocal(APP_STATE);
        });
        qty.append(minus,input,plus);

        const rm = document.createElement("button");
        rm.className = "btn danger";
        rm.textContent = "Remover";
        rm.addEventListener("click", ()=>{
          APP_STATE.cart.splice(idx,1);
          renderCart(); updateCartTotals(); saveLocal(APP_STATE);
        });

        row2.append(price, qty, rm);
        body.append(title,opt,note,row2);
        row.append(body);
        list.append(row);
      });
    }

    function cartSubtotal(){
      return (APP_STATE.cart||[]).reduce((s,c)=>s + c.price*c.qty, 0);
    }
    function updateCartTotals(){
      const delivery = Number(APP_STATE.settings.deliveryFee||0);
      const sub = cartSubtotal();
      const total = sub + delivery;
      document.getElementById("subtotalValue").textContent = R$(sub);
      document.getElementById("deliveryValue").textContent = R$(delivery);
      document.getElementById("totalValue").textContent = R$(total);
    }

    // WhatsApp mini cupom
    function buildMiniCupom(){
      const now = new Date();
      const pad = n=>String(n).padStart(2,"0");
      const dh = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
      const loja = APP_STATE.settings.storeName || "Minha Loja";

      let lines = [];
      lines.push(`${loja} — Pedido`);
      lines.push(dh);
      (APP_STATE.cart||[]).forEach(c=>{
        lines.push(`${c.qty}x ${c.name}${c.options?` (${c.options})`:``} — ${R$(c.price)} — Sub: ${R$(c.qty*c.price)}`);
        if(c.note){ lines.push(`  obs: ${c.note}`); }
      });
      const sub = cartSubtotal();
      const entrega = Number(APP_STATE.settings.deliveryFee||0);
      lines.push(`Subtotal: ${R$(sub)}`);
      lines.push(`Entrega: ${R$(entrega)}`);
      lines.push(`Total: ${R$(sub+entrega)}`);

      // Cliente
      const nome = document.getElementById("customerName").value||"";
      const fone = document.getElementById("customerPhone").value||"";
      const end = document.getElementById("customerAddress").value||"";
      const pay = document.getElementById("paymentMethod").value||"";
      const troco = document.getElementById("changeValue").value||"";
      const geral = document.getElementById("orderNote").value||"";

      if(nome || fone) lines.push(`Cliente: ${nome}${fone?` — ${fone}`:""}`);
      if(end) lines.push(`Endereço: ${end}`);
      if(pay) lines.push(`Pagamento: ${pay}${pay==="Dinheiro"&&troco?` (troco para ${R$(parseMoney(troco))})`:""}`);
      if(geral) lines.push(`Observação: ${geral}`);

      return lines.join("\n");
    }

    function openWhatsApp(){
      const target = (APP_STATE.settings.whatsTarget||"").replace(/\D/g,"");
      const txt = encodeURIComponent(buildMiniCupom());
      const url = target ? `https://wa.me/${target}?text=${txt}` : `https://wa.me/?text=${txt}`;
      window.open(url, "_blank", "noopener");
    }

    // Admin
    function openAdminModal(){ document.getElementById("adminModal").style.display="flex"; }
    function closeAdminModal(){ document.getElementById("adminModal").style.display="none"; }

    function renderAdmin(){
      // Carrega valores
      const s = APP_STATE.settings;
      document.getElementById("cfgStoreName").value = s.storeName||"";
      document.getElementById("cfgStoreTag").value = s.storeTag||"";
      document.getElementById("cfgDeliveryFee").value = String(s.deliveryFee||0);
      document.getElementById("cfgWhatsTarget").value = s.whatsTarget||"";
      document.getElementById("cfgFooterNote").value = s.footerNote||"";

      document.getElementById("cfgPhone").value = s.contact?.phone||"";
      document.getElementById("cfgWhats").value = s.contact?.whats||"";
      document.getElementById("cfgInsta").value = s.contact?.insta||"";
      document.getElementById("cfgFb").value = s.contact?.fb||"";

      document.getElementById("hidePhone").checked = !!s.contact?.hide?.phone;
      document.getElementById("hideWhats").checked = !!s.contact?.hide?.whats;
      document.getElementById("hideInsta").checked = !!s.contact?.hide?.insta;
      document.getElementById("hideFb").checked = !!s.contact?.hide?.fb;

      // Editor de categorias
      const ed = document.getElementById("categoriesEditor");
      ed.innerHTML = "";
      (APP_STATE.menu||[]).forEach(cat=>{
        const catBox = document.createElement("div");
        catBox.className = "card section";
        catBox.style.marginBottom="10px";
        catBox.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <input class="input" value="${escapeHtml(cat.name)}" data-key="cat-name">
            <div class="row">
              <button class="btn small" data-act="add-sub">+ Subgrupo</button>
              <button class="btn danger small" data-act="rm-cat">Remover</button>
            </div>
          </div>
          <div class="divider"></div>
          <div data-slot="subs"></div>
        `;
        const inputName = catBox.querySelector('[data-key="cat-name"]');
        inputName.addEventListener("input", e=>{ cat.name = e.target.value; renderFilters(); renderMenu(); });

        const subsSlot = catBox.querySelector('[data-slot="subs"]');
        (cat.subgroups||[]).forEach(sg=>{
          const sgBox = document.createElement("div");
          sgBox.className="card section";
          sgBox.style.background="#0f131b";
          sgBox.style.marginBottom="10px";
          sgBox.innerHTML = `
            <div class="row" style="justify-content:space-between">
              <input class="input" value="${escapeHtml(sg.name)}" data-key="sg-name">
              <div class="row">
                <button class="btn small" data-act="add-item">+ Item</button>
                <button class="btn danger small" data-act="rm-sg">Remover Subgrupo</button>
              </div>
            </div>
            <div class="divider"></div>
            <div data-slot="items"></div>
          `;
          sgBox.querySelector('[data-key="sg-name"]').addEventListener("input", e=>{ sg.name=e.target.value; renderMenu(); });

          const itemsSlot = sgBox.querySelector('[data-slot="items"]');
          (sg.items||[]).forEach(it=>{
            const itBox = document.createElement("div");
            itBox.className="card section";
            itBox.style.background="#0c0f14";
            itBox.style.marginBottom="8px";
            itBox.innerHTML = `
              <div class="form-row">
                <input class="input" placeholder="Nome" value="${escapeHtml(it.name)}" data-key="name">
                <input class="input" placeholder="Preço" value="${String(it.price)}" data-key="price">
                <label class="muted small"><input type="checkbox" data-key="available" ${it.available?"checked":""}> Disponível</label>
              </div>
              <div class="form-row">
                <textarea class="input" placeholder="Descrição" data-key="desc">${escapeHtml(it.desc||"")}</textarea>
              </div>
              <div class="form-row">
                <input class="input" placeholder="Variações/Opções" value="${escapeHtml(it.options||"")}" data-key="options">
              </div>
              <div class="form-row">
                <input type="file" accept="image/*" data-key="file">
                <button class="btn small" data-act="rm-img">Remover imagem</button>
              </div>
              <div class="form-row">
                <img src="${it.image?it.image:"https://placehold.co/168x168/0b0f16/96a3b8?text=IMG"}" style="width:96px;height:96px;border-radius:10px;object-fit:cover;border:1px solid #273044;background:#0b0f16" data-key="preview">
              </div>
              <div class="row" style="justify-content:flex-end">
                <button class="btn danger small" data-act="rm-item">Remover item</button>
              </div>
            `;
            // Handlers item
            itBox.querySelector('[data-key="name"]').addEventListener("input", e=>{ it.name=e.target.value; renderMenu(); });
            itBox.querySelector('[data-key="price"]').addEventListener("input", e=>{ it.price=parseMoney(e.target.value); renderMenu(); });
            itBox.querySelector('[data-key="available"]').addEventListener("change", e=>{ it.available=!!e.target.checked; renderMenu(); });
            itBox.querySelector('[data-key="desc"]').addEventListener("input", e=>{ it.desc=e.target.value; renderMenu(); });
            itBox.querySelector('[data-key="options"]').addEventListener("input", e=>{ it.options=e.target.value; });

            const fileInput = itBox.querySelector('[data-key="file"]');
            const preview = itBox.querySelector('[data-key="preview"]');
            fileInput.addEventListener("change", async (e)=>{
              const file = e.target.files?.[0];
              if(!file) return;
              const dataUrl = await resizeImage(file, 600, 600, 0.85);
              it.image = dataUrl;
              preview.src = dataUrl;
              renderMenu();
            });

            itBox.querySelector('[data-act="rm-img"]').addEventListener("click", ()=>{
              it.image = "";
              preview.src = "https://placehold.co/168x168/0b0f16/96a3b8?text=IMG";
              renderMenu();
            });

            itBox.querySelector('[data-act="rm-item"]').addEventListener("click", ()=>{
              const idx = sg.items.findIndex(x=>x.id===it.id);
              if(idx>=0){ sg.items.splice(idx,1); renderAdmin(); renderMenu(); }
            });

            itemsSlot.appendChild(itBox);
          });

          sgBox.querySelector('[data-act="add-item"]').addEventListener("click", ()=>{
            (sg.items ||= []).push({id:uid(), name:"Novo item", desc:"", price:0, image:"", options:"", available:true});
            renderAdmin(); renderMenu();
          });

          sgBox.querySelector('[data-act="rm-sg"]').addEventListener("click", ()=>{
            const idx = cat.subgroups.findIndex(x=>x.id===sg.id);
            if(idx>=0){ cat.subgroups.splice(idx,1); renderAdmin(); renderMenu(); }
          });

          subsSlot.appendChild(sgBox);
        });

        catBox.querySelector('[data-act="add-sub"]').addEventListener("click", ()=>{
          (cat.subgroups ||= []).push({id:uid(), name:"Novo subgrupo", items:[]});
          renderAdmin(); renderMenu();
        });

        catBox.querySelector('[data-act="rm-cat"]').addEventListener("click", ()=>{
          const idx = APP_STATE.menu.findIndex(x=>x.id===cat.id);
          if(idx>=0){ APP_STATE.menu.splice(idx,1); renderAdmin(); renderFilters(); renderMenu(); }
        });

        ed.appendChild(catBox);
      });
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    async function resizeImage(file, maxW, maxH, q=0.85){
      const img = new Image();
      const buf = await file.arrayBuffer();
      const blob = new Blob([buf], {type:file.type});
      const url = URL.createObjectURL(blob);
      await new Promise(res=>{ img.onload=()=>res(); img.src=url; });
      const ratio = Math.min(maxW/img.width, maxH/img.height, 1);
      const w = Math.round(img.width * ratio);
      const h = Math.round(img.height * ratio);
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      const dataUrl = canvas.toDataURL("image/jpeg", q);
      URL.revokeObjectURL(url);
      return dataUrl;
    }

    // Eventos UI
    document.getElementById("searchInput").addEventListener("input", debounce(()=>renderMenu(), 200));

    document.getElementById("toggleContactBtn").addEventListener("click", ()=>{
      document.getElementById("contactBlock").classList.toggle("hide");
    });

    document.getElementById("clearCartBtn").addEventListener("click", ()=>{
      APP_STATE.cart = [];
      renderCart(); updateCartTotals(); saveLocal(APP_STATE);
    });

    document.getElementById("sendWhatsApp").addEventListener("click", openWhatsApp);

    // Admin modal
    document.getElementById("openAdmin").addEventListener("click", openAdminModal);
    document.getElementById("closeAdmin").addEventListener("click", closeAdminModal);

    // Admin login
    document.getElementById("adminLoginBtn").addEventListener("click", ()=>{
      const pass = document.getElementById("adminPasswordInput").value||"";
      const status = document.getElementById("adminLoginStatus");
      if(pass === APP_STATE.settings.adminPassword){
        status.textContent = "Autenticado.";
        document.getElementById("adminContent").classList.remove("hide");
        renderAdmin();
      }else{
        status.textContent = "Senha incorreta.";
      }
    });

    // Admin salvar
    document.getElementById("saveAllBtn").addEventListener("click", async ()=>{
      // Coleta campos
      const s = APP_STATE.settings;
      s.storeName = document.getElementById("cfgStoreName").value||"";
      s.storeTag = document.getElementById("cfgStoreTag").value||"";
      s.deliveryFee = parseMoney(document.getElementById("cfgDeliveryFee").value||"0");
      s.whatsTarget = (document.getElementById("cfgWhatsTarget").value||"").replace(/\D/g,"");
      s.footerNote = document.getElementById("cfgFooterNote").value||"";

      s.contact ||= {hide:{}};
      s.contact.phone = document.getElementById("cfgPhone").value||"";
      s.contact.whats = document.getElementById("cfgWhats").value||"";
      s.contact.insta = document.getElementById("cfgInsta").value||"";
      s.contact.fb = document.getElementById("cfgFb").value||"";
      s.contact.hide ||= {};
      s.contact.hide.phone = document.getElementById("hidePhone").checked;
      s.contact.hide.whats = document.getElementById("hideWhats").checked;
      s.contact.hide.insta = document.getElementById("hideInsta").checked;
      s.contact.hide.fb = document.getElementById("hideFb").checked;

      await saveState();
      renderAll();
      alert("Alterações salvas.");
    });

    document.getElementById("addCategoryBtn").addEventListener("click", ()=>{
      APP_STATE.menu.push({id:uid(), name:"Nova categoria", subgroups:[]});
      renderAdmin(); renderFilters(); renderMenu();
    });

    // Init
    (async function(){
      await loadState();
      listenRealtime();
      // Carrega carrinho local caso tenha vindo do Firestore sem carrinho
      const local = loadLocal();
      if(local?.cart?.length && (!APP_STATE.cart || APP_STATE.cart.length===0)){
        APP_STATE.cart = local.cart;
      }
      renderAll();
      renderCart();
    })();
  </script>
</body>
</html>
